FROM @PROTONSDK_URLBASE@/binutils-@ARCH@-linux-gnu:@BINUTILS_VERSION@ AS binutils-linux
FROM @PROTONSDK_URLBASE@/binutils-@ARCH@-w64-mingw32:@BINUTILS_VERSION@ AS binutils-mingw
FROM @PROTONSDK_URLBASE@/mingw-headers-@ARCH@:@MINGW_VERSION@ AS mingw-headers
FROM @PROTONSDK_URLBASE@/mingw-crt-@ARCH@:@MINGW_VERSION@ AS mingw-crt
FROM @PROTONSDK_URLBASE@/mingw-pthreads-@ARCH@:@MINGW_VERSION@ AS mingw-pthreads
FROM @PROTONSDK_URLBASE@/mingw-widl-@ARCH@:@MINGW_VERSION@ AS mingw-widl
FROM @PROTONSDK_URLBASE@/gcc-@ARCH@-linux-gnu:@GCC_VERSION@ AS gcc-linux
FROM @PROTONSDK_URLBASE@/gcc-@ARCH@-w64-mingw32:@GCC_VERSION@ AS gcc-mingw

FROM @BASE_IMAGE@ AS base
RUN echo "deb-src http://ftp.debian.org/debian/ unstable main non-free contrib" >> /etc/apt/sources.list \
&& apt-get update \
&& apt-get build-dep wine -y \
&& apt-get install -y \
  autoconf2.13 \
  ccache \
  tini \
  unzip \
  valgrind \
  yasm \
  zip \
&& rm -rf /opt/usr/share/doc /opt/usr/share/info /opt/usr/share/man \
&& rm -rf /var/lib/apt/lists/*

COPY --from=binutils-linux /opt/usr /usr
COPY --from=binutils-mingw /opt/usr /usr
COPY --from=mingw-headers  /opt/usr /usr
COPY --from=mingw-crt      /opt/usr /usr
COPY --from=mingw-pthreads /opt/usr /usr
COPY --from=mingw-widl     /opt/usr /usr
COPY --from=gcc-linux      /opt/usr /usr
COPY --from=gcc-mingw      /opt/usr /usr

RUN bash -c 'mkdir -p /usr/lib/ccache && ls /usr/bin/{,*-}{cc,c++,gcc,g++}{,-[0-9]*} | sed -re s:/bin:/lib/ccache: | xargs -n1 ln -sf ../../bin/ccache'

ENTRYPOINT ["/usr/bin/tini-static", "-s", "-g", "--"]

ENV PATH=/usr/lib/ccache:$PATH
ENV CC=@ARCH@-linux-gnu-gcc
ENV CXX=@ARCH@-linux-gnu-g++
ENV CROSSCC=@ARCH@-w64-mingw32-gcc
ENV CROSSCXX=@ARCH@-w64-mingw32-g++
CMD ["/bin/bash"]

FROM @BASE_IMAGE@ AS base
RUN dpkg --add-architecture i386 \
&& mkdir -p \
  /usr/lib/debug \
  /usr/share/doc/libuim-dev \
  /usr/share/info \
  /usr/share/man \
  /usr/share/locale \
&& echo 'path-exclude=/usr/share/lib/debug' > /etc/dpkg/dpkg.cfg.d/99-exclude-cruft \
&& echo 'path-exclude=/usr/share/doc/*' > /etc/dpkg/dpkg.cfg.d/99-exclude-cruft \
&& echo 'path-exclude=/usr/share/info/*' >> /etc/dpkg/dpkg.cfg.d/99-exclude-cruft \
&& echo 'path-exclude=/usr/share/locale/*' >> /etc/dpkg/dpkg.cfg.d/99-exclude-cruft \
&& echo 'path-exclude=/usr/share/man/*' >> /etc/dpkg/dpkg.cfg.d/99-exclude-cruft \
&& echo 'APT::Install-Recommends "false";' > /etc/apt/apt.conf \
&& echo '#!/bin/sh' > /usr/sbin/policy-rc.d \
&& echo 'exit 101' >> /usr/sbin/policy-rc.d \
&& chmod +x /usr/sbin/policy-rc.d \
&& useradd -m user1000 \
&& useradd -m user1001 \
&& apt-get update \
&& apt-get install -y \
  aptitude \
  autoconf \
  autoconf2.13 \
  bison \
  ccache \
  curl \
  flex \
  fonts-liberation2 \
  fonts-noto-cjk \
  fonts-noto-core \
  fvwm \
  gettext \
  git \
  i3 \
  ibus \
  kwin-wayland \
  kwin-x11 \
  libmpc3 \
  libmpfr6 \
  lwm \
  make \
  marco \
  metacity \
  muffin \
  mutter \
  mwm \
  openbox \
  pekwm \
  pkg-config \
  pulseaudio \
  spectrwm \
  sway \
  tini \
  uim \
  unagi \
  unzip \
  valgrind \
  weston \
  winbind \
  x11-utils \
  x11-xserver-utils \
  xfonts-base \
  xfwm4 \
  xinit \
  xmonad \
  xserver-xorg \
  xserver-xorg-video-dummy \
  yasm \
  zip \
&& echo "allowed_users=anybody" >> /etc/X11/Xwrapper.config \
&& echo "needs_root_rights=no" >> /etc/X11/Xwrapper.config \
&& aptitude update \
&& aptitude install -y \
  gir1.2-gst-plugins-base-1.0:amd64 gir1.2-gst-plugins-base-1.0:i386 \
  gstreamer1.0-libav:amd64 gstreamer1.0-libav:i386 \
  gstreamer1.0-plugins-bad:amd64 gstreamer1.0-plugins-bad:i386 \
  gstreamer1.0-plugins-good:amd64 gstreamer1.0-plugins-good:i386 \
  gstreamer1.0-plugins-ugly:amd64 gstreamer1.0-plugins-ugly:i386 \
  libasound2-plugins:amd64 libasound2-plugins:i386 \
  libcapi20-3:amd64 libcapi20-3:i386 \
  libcups2:amd64 libcups2:i386 \
  libdbus-1-3:amd64 libdbus-1-3:i386 \
  libfontconfig:amd64 libfontconfig:i386 \
  libfreetype6:amd64 libfreetype6:i386 \
  libgl1-mesa-dri:amd64 libgl1-mesa-dri:i386 \
  libgnutls30:amd64 libgnutls30:i386 \
  libgphoto2-6:amd64 libgphoto2-6:i386 \
  libgstreamer-gl1.0-0:amd64 libgstreamer-gl1.0-0:i386 \
  libice6:amd64 libice6:i386 \
  libkrb5-3:amd64 libkrb5-3:i386 \
  libldap-2.5-0:amd64 libldap-2.5-0:i386 \
  libmjpegutils-2.1-0:amd64 libmjpegutils-2.1-0:i386 \
  libmjpegutils-2.1-0:amd64 libmjpegutils-2.1-0:i386 \
  libopenal1:amd64 libopenal1:i386 \
  libosmesa6:amd64 libosmesa6:i386 \
  libpcap0.8:amd64 libpcap0.8:i386 \
  libpulse0:amd64 libpulse0:i386 \
  libsane:amd64 libsane:i386 \
  libsdl2-2.0-0:amd64 libsdl2-2.0-0:i386 \
  libudev0:amd64 libudev0:i386 \
  libusb-1.0-0:amd64 libusb-1.0-0:i386 \
  libv4l-0:amd64 libv4l-0:i386 \
  libvulkan1:amd64 libvulkan1:i386 \
  libx11-6:amd64 libx11-6:i386 \
  libxcomposite1:amd64 libxcomposite1:i386 \
  libxcursor1:amd64 libxcursor1:i386 \
  libxext6:amd64 libxext6:i386 \
  libxi6:amd64 libxi6:i386 \
  libxinerama1:amd64 libxinerama1:i386 \
  libxrandr2:amd64 libxrandr2:i386 \
  libxrender1:amd64 libxrender1:i386 \
  libxxf86vm1:amd64 libxxf86vm1:i386 \
  samba:amd64 samba:i386 \
  unixodbc:amd64 unixodbc:i386 \
&& aptitude install -y \
  libasound2-dev:amd64 libasound2-dev:i386 \
  libcairo2-dev:amd64 libcairo2-dev:i386 \
  libcapi20-dev:amd64 libcapi20-dev:i386 \
  libdbus-1-dev:amd64 libdbus-1-dev:i386 \
  libfaudio-dev:amd64 libfaudio-dev:i386 \
  libfontconfig1-dev:amd64 libfontconfig1-dev:i386 \
  libfreetype6-dev:amd64 libfreetype6-dev:i386 \
  libgettextpo-dev:amd64 libgettextpo-dev:i386 \
  libgl1-mesa-dev:amd64 libgl1-mesa-dev:i386 \
  libglu1-mesa-dev:amd64 libglu1-mesa-dev:i386 \
  libgmp-dev:amd64 libgmp-dev:i386 \
  libgnutls28-dev:amd64 libgnutls28-dev:i386 \
  libgphoto2-dev:amd64 libgphoto2-dev:i386 \
  libgsm1-dev:amd64 libgsm1-dev:i386 \
  libgsm1-dev:amd64 libgsm1-dev:i386 \
  libgstreamer-plugins-base1.0-dev:amd64 \
  libgstreamer1.0-dev:amd64 libgstreamer1.0-dev:i386 \
  libgudev-1.0-dev:amd64 libgudev-1.0-dev:i386 \
  libibus-1.0-dev:amd64 libibus-1.0-dev:i386 \
  libisl-dev:amd64 libisl-dev:i386 \
  libjpeg-dev:amd64 libjpeg-dev:i386 \
  libjxr-dev:amd64 libjxr-dev:i386 \
  libkrb5-dev:amd64 libkrb5-dev:i386 \
  liblcms2-dev:amd64 liblcms2-dev:i386 \
  libldap2-dev:amd64 libldap2-dev:i386 \
  libmjpegtools-dev:amd64 libmjpegtools-dev:i386 \
  libmpg123-dev:amd64 libmpg123-dev:i386 \
  libncurses5-dev:amd64 libncurses5-dev:i386 \
  libopenal-dev:amd64 libopenal-dev:i386 \
  liborc-0.4-dev:amd64 liborc-0.4-dev:i386 \
  libosmesa6-dev:amd64 libosmesa6-dev:i386 \
  libpcap-dev:amd64 libpcap-dev:i386 \
  libpcap0.8-dev:amd64 libpcap0.8-dev:i386 \
  libpng-dev:amd64 libpng-dev:i386 \
  libpulse-dev:amd64 libpulse-dev:i386 \
  libsane-dev:amd64 libsane-dev:i386 \
  libsdl2-dev:amd64 libsdl2-dev:i386 \
  libssl-dev:amd64 libssl-dev:i386 \
  libtiff-dev:amd64 libtiff-dev:i386 \
  libudev-dev:amd64 libudev-dev:i386 \
  libuim-dev:amd64 libuim-dev:i386 \
  libusb-1.0-0-dev:amd64 libusb-1.0-0-dev:i386 \
  libv4l-dev:amd64 libv4l-dev:i386 \
  libvkd3d-dev:amd64 libvkd3d-dev:i386 \
  libvulkan-dev:amd64 libvulkan-dev:i386 \
  libwayland-dev:amd64 libwayland-dev:i386 \
  libx11-dev:amd64 libx11-dev:i386 \
  libx11-xcb-dev:amd64 libx11-xcb-dev:i386 \
  libxcb-composite0-dev:amd64 libxcb-composite0-dev:i386 \
  libxcb-cursor-dev:amd64 libxcb-cursor-dev:i386 \
  libxcb-damage0-dev:amd64 libxcb-damage0-dev:i386 \
  libxcb-dpms0-dev:amd64 libxcb-dpms0-dev:i386 \
  libxcb-dri2-0-dev:amd64 libxcb-dri2-0-dev:i386 \
  libxcb-dri3-dev:amd64 libxcb-dri3-dev:i386 \
  libxcb-ewmh-dev:amd64 libxcb-ewmh-dev:i386 \
  libxcb-glx0-dev:amd64 libxcb-glx0-dev:i386 \
  libxcb-icccm4-dev:amd64 libxcb-icccm4-dev:i386 \
  libxcb-image0-dev:amd64 libxcb-image0-dev:i386 \
  libxcb-imdkit-dev:amd64 libxcb-imdkit-dev:i386 \
  libxcb-keysyms1-dev:amd64 libxcb-keysyms1-dev:i386 \
  libxcb-present-dev:amd64 libxcb-present-dev:i386 \
  libxcb-randr0-dev:amd64 libxcb-randr0-dev:i386 \
  libxcb-record0-dev:amd64 libxcb-record0-dev:i386 \
  libxcb-render-util0-dev:amd64 libxcb-render-util0-dev:i386 \
  libxcb-render0-dev:amd64 libxcb-render0-dev:i386 \
  libxcb-res0-dev:amd64 libxcb-res0-dev:i386 \
  libxcb-screensaver0-dev:amd64 libxcb-screensaver0-dev:i386 \
  libxcb-shape0-dev:amd64 libxcb-shape0-dev:i386 \
  libxcb-shm0-dev:amd64 libxcb-shm0-dev:i386 \
  libxcb-sync-dev:amd64 libxcb-sync-dev:i386 \
  libxcb-util-dev:amd64 libxcb-util-dev:i386 \
  libxcb-util0-dev:amd64 libxcb-util0-dev:i386 \
  libxcb-xf86dri0-dev:amd64 libxcb-xf86dri0-dev:i386 \
  libxcb-xfixes0-dev:amd64 libxcb-xfixes0-dev:i386 \
  libxcb-xinerama0-dev:amd64 libxcb-xinerama0-dev:i386 \
  libxcb-xinput-dev:amd64 libxcb-xinput-dev:i386 \
  libxcb-xkb-dev:amd64 libxcb-xkb-dev:i386 \
  libxcb-xrm-dev:amd64 libxcb-xrm-dev:i386 \
  libxcb-xtest0-dev:amd64 libxcb-xtest0-dev:i386 \
  libxcb-xv0-dev:amd64 libxcb-xv0-dev:i386 \
  libxcb-xvmc0-dev:amd64 libxcb-xvmc0-dev:i386 \
  libxcb1-dev:amd64 libxcb1-dev:i386 \
  libxcomposite-dev:amd64 libxcomposite-dev:i386 \
  libxcursor-dev:amd64 libxcursor-dev:i386 \
  libxext-dev:amd64 libxext-dev:i386 \
  libxfixes-dev:amd64 libxfixes-dev:i386 \
  libxi-dev:amd64 libxi-dev:i386 \
  libxinerama-dev:amd64 libxinerama-dev:i386 \
  libxkbfile-dev:amd64 libxkbfile-dev:i386 \
  libxml2-dev:amd64 libxml2-dev:i386 \
  libxmu-dev:amd64 libxmu-dev:i386 \
  libxpresent-dev:amd64 libxpresent-dev:i386 \
  libxrandr-dev:amd64 libxrandr-dev:i386 \
  libxrender-dev:amd64 libxrender-dev:i386 \
  libxslt1-dev:amd64 libxslt1-dev:i386 \
  libxt-dev:amd64 libxt-dev:i386 \
  libxxf86dga-dev:amd64 libxxf86dga-dev:i386 \
  libxxf86vm-dev:amd64 libxxf86vm-dev:i386 \
  linux-libc-dev:amd64 linux-libc-dev:i386 \
  opencl-dev:amd64 opencl-dev:i386 \
  oss4-dev:amd64 \
  samba-dev:amd64 samba-dev:i386 \
  systemtap-sdt-dev:amd64 systemtap-sdt-dev:i386 \
  unixodbc-dev:amd64 unixodbc-dev:i386 \
&& apt-get autoremove -y \
&& apt-get clean \
&& apt-get download libgstreamer-plugins-base1.0-dev:i386 \
&& dpkg-deb -x libgstreamer-plugins-base1.0-dev_*_i386.deb /dpkg \
&& cp -rf /dpkg/usr/lib/i386-linux-gnu /usr/lib/ \
&& rm -rf /dpkg libgstreamer-plugins-base1.0-dev_*_i386.deb \
&& rm -rf \
  /usr/lib/debug \
  /usr/share/doc \
  /usr/share/info \
  /usr/share/man \
  /usr/share/locale \
  /var/lib/apt/lists/* \
  /var/lib/dpkg/info/*.symbols \
;

ENTRYPOINT ["/usr/bin/tini-static", "-s", "-g", "--"]

ENV PATH=/usr/lib/ccache:$PATH
CMD ["/bin/bash"]
